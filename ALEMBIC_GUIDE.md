# Alembic Database Migration Guide

This project uses Alembic for database schema version control and migrations. This guide explains how to use the migration system effectively.

## Prerequisites

- Python 3.8+
- Database URL set in environment variable `DATABASE_URL`
- All models defined in `app/models.py`

## Quick Start

### 1. Initial Setup

If this is the first time running Alembic:

```bash
# Make sure DATABASE_URL is set
export DATABASE_URL="postgresql://user:password@localhost/dbname"

# Initialize Alembic (already done in this project)
alembic init alembic
```

### 2. Check Current Status

```bash
# Check current database revision
alembic current

# Show migration history
alembic history
```

### 3. Create a New Migration

Whenever you modify models in `app/models.py`:

```bash
# Autogenerate migration from model changes
alembic revision --autogenerate -m "description of changes"

# Review the generated migration file in alembic/versions/
# Then apply it
alembic upgrade head
```

### 4. Apply Migrations

```bash
# Apply all pending migrations
alembic upgrade head

# Upgrade to a specific revision
alembic upgrade <revision_id>

# Apply next migration only
alembic upgrade +1
```

### 5. Rollback Migrations

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to a specific revision
alembic downgrade <revision_id>

# Rollback all migrations
alembic downgrade base
```

## Common Workflows

### Adding a New Model

1. Add your model class to `app/models.py`:
```python
from app.database import Base

class MyNewModel(Base):
    __tablename__ = "my_new_model"
    id = Column(String, primary_key=True)
    name = Column(String)
    # ... other columns
```

2. Import it in `alembic/env.py` (already done automatically if you follow the pattern):
```python
from app.models import (
    # ... existing imports
    MyNewModel  # Add here
)
```

3. Generate and apply migration:
```bash
alembic revision --autogenerate -m "add MyNewModel"
alembic upgrade head
```

### Modifying an Existing Model

1. Make your changes to the model in `app/models.py`
2. Generate migration:
```bash
alembic revision --autogenerate -m "modify User model"
```
3. Review and edit the generated migration if needed
4. Apply migration:
```bash
alembic upgrade head
```

## Troubleshooting

### Issue: "Target database is not up to date"

**Solution:** Apply pending migrations
```bash
alembic upgrade head
```

### Issue: "Can't locate revision identified by ..."

**Solution:** This happens when migration history is out of sync. Check revision chain:
```bash
alembic history
alembic current
```

### Issue: "DATABASE_URL not found"

**Solution:** Set the environment variable
```bash
export DATABASE_URL="postgresql://user:password@localhost/dbname"
```

Or on Windows:
```cmd
set DATABASE_URL=postgresql://user:password@localhost/dbname
```

### Issue: Migration conflicts or merge conflicts

**Solution:** Stamp the database to match current model state
```bash
# Only use if you know what you're doing!
alembic stamp head
```

## Best Practices

1. **Always review autogenerated migrations** before applying them
2. **Test migrations on a development database first**
3. **Keep migration files in version control**
4. **Don't edit existing migration files** (create a new one instead)
5. **Use descriptive messages** for migration revisions
6. **Backup your database** before running migrations in production

## Architecture

- **alembic.ini**: Main configuration file
- **alembic/env.py**: Defines how migrations run, imports models
- **alembic/versions/**: Contains all migration files
- **app/models.py**: Your SQLAlchemy models

## How It Works

1. Alembic reads model definitions from `app/models.py`
2. Compares them with the current database schema
3. Generates migration SQL commands
4. Applies them to update the database schema

## Environment Variables

Required:
- `DATABASE_URL`: PostgreSQL connection string (e.g., `postgresql://user:password@localhost/dbname`)

Optional:
- `PYTHONPATH`: Add project root if running from different directory

## Example Migration Workflow

```bash
# 1. Make model changes in app/models.py
# (e.g., add new column to User model)

# 2. Generate migration
alembic revision --autogenerate -m "add email_verified column"

# 3. Review generated file in alembic/versions/
# (check that changes are correct)

# 4. Apply migration
alembic upgrade head

# 5. Verify in database
# (connect to DB and check the changes)

# 6. Commit to git
git add alembic/versions/your_migration.py
git commit -m "Add email_verified column to users table"
```

## Advanced Usage

### Offline Mode (Generate SQL without connecting)

```bash
alembic upgrade head --sql
```

### Show SQL for a specific migration

```bash
alembic upgrade head --sql > migration.sql
```

### Multiple Databases

If you have multiple databases, you can use `--name` flag:
```bash
alembic -n production upgrade head
```

## Notes

- This setup uses `render_as_batch=True` for SQLite compatibility
- Migrations include `compare_type=True` and `compare_server_default=True` for better detection
- All migrations run in transactions (auto-rollback on error)

